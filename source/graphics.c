#include <graphics.h>

static const pixel_t red = {.red = 0xFF};
static const pixel_t green = {.green = 0xFF};
static const pixel_t blue = {.blue = 0xFF};
static const pixel_t white = {.red = 0xFF, .green = 0xFF, .blue = 0xFF};
static const pixel_t black;

static fb_info_t fb_info  __attribute__((aligned(16)));
static graphics_info_t g_info = {.background=&black, .foreground=&white};

const uint8_t char_ERR[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_SPACE[] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_A[] = {0x18, 0x18, 0x3C, 0x3C, 0x66, 0x66, 0x66, 0x66, 0xFF, 0xC3, 0xC3, 0xC3, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_B[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_C[] = {0x3C, 0x7E, 0x66, 0x62, 0xC0, 0xC0, 0x80, 0x80, 0x81, 0xE7, 0x7E, 0x3C, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_D[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_E[] = {0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_F[] = {0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_G[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_H[] = {0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xC3, 0xC3, 0xC3, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_I[] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_J[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_K[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_L[] = {0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_M[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_N[] = {0xC1, 0xC1, 0xC1, 0xE1, 0xE1, 0xF1, 0xD1, 0xD9, 0xCD, 0xC5, 0xC7, 0xC3, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_O[] = {0x3C, 0x7E, 0x66, 0x66, 0xC3, 0xC3, 0x81, 0x81, 0x81, 0xE7, 0x7E, 0x3C, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_P[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_Q[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_R[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_S[] = {0x3C, 0x7F, 0x43, 0xC1, 0xC0, 0xC0, 0xE0, 0x7E, 0x03, 0xC3, 0xF7, 0x3C, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_T[] = {0xFF, 0xFF, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_U[] = {0x42, 0x42, 0x42, 0xC3, 0xC3, 0xC3, 0x81, 0x81, 0x81, 0xC3, 0x7E, 0x3C, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_V[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_W[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_X[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_Y[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};
const uint8_t char_Z[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00};

void framebufferInit() {
    // Fill out non-zero properties of fb init message
    fb_info.width = 800;
    fb_info.height = 480;
    fb_info.virtual_width = 800;
    fb_info.virtual_height = 480;
    fb_info.depth = 24;

    // Send 28 MSBs of message addr and channel selection (1 on MB 0) as data
    uint32_t request = BUS_ADDR_BASE | (uint32_t)&fb_info | 0x1;
    uint32_t response;
    do {
        mailboxWrite(request);
        response = mailboxRead(1);
    } while (!(response >> 4)); // TODO(2/2/19): verify that this can actually fail and 
                                //               remove if it can't

    // Ensure we initialize to a known clean state
    clearFrame();

    puts("THE QUICK BROWN FOX JUMPS OVER THE LAZY DOG");
}

void puts(const char* str) {
    while(*str) {
        putc(*str++);
    }
}
void clearFrame() {
    for (uint32_t i = 0; i < fb_info.buff_size ; i++) {
        *(fb_info.buff_addr + i) = 0x00;
    }
}

void drawPixel(int x, int y, const pixel_t * pixel) {
    uint8_t * target = fb_info.buff_addr + (y * fb_info.pitch) + (x * PIXEL_BYTES);

    *(target) = pixel->blue;
    *(target + 1) = pixel->green;
    *(target + 2) = pixel->red;
}

void putc(char c) {
    const uint8_t * bitmap = getCharBitmap(c);
    int x_offset = g_info.column_index * CHAR_WIDTH;
    int y_offset = g_info.row_index * LINE_HEIGHT;

    for (int y = 0; y < 16; y++) {
        for (int x = 0; x < 8; x++) {
            if (bitmap[y] & (1 << x)) {
                drawPixel(8 - x - 1 + x_offset , y + y_offset, g_info.foreground);
            } else {
                drawPixel(8 - x - 1 + x_offset , y + y_offset, g_info.background);
            }
        }
    }

    g_info.column_index++;
    if (g_info.column_index == 10) {
        g_info.column_index = 0;
        g_info.row_index++;
    }
}

const uint8_t * getCharBitmap(char c) {
    switch(c) {
        case 'A':
            return char_A;
        case 'B':
            return char_B;
        case 'C':
            return char_C;
        case 'D':
            return char_D;
        case 'E':
            return char_E;
        case 'F':
            return char_F;
        case 'G':
            return char_G;
        case 'H':
            return char_H;
        case 'I':
            return char_I;
        case 'J':
            return char_J;
        case 'K':
            return char_K;
        case 'L':
            return char_L;
        case 'M':
            return char_M;
        case 'N':
            return char_N;
        case 'O':
            return char_O;
        case 'P':
            return char_P;
        case 'Q':
            return char_Q;
        case 'R':
            return char_R;
        case 'S':
            return char_S;
        case 'T':
            return char_T;
        case 'U':
            return char_U;
        case 'V':
            return char_V;
        case 'W':
            return char_W;
        case 'X':
            return char_X;
        case 'Y':
            return char_Y;
        case 'Z':
            return char_Z;
        case ' ':
            return char_SPACE;
        default:
            return char_ERR;
    }
}
